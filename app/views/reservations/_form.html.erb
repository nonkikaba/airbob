<div class="card">
  <div class="card-header">
    <span><i class="fa fa-bolt" style="#ffb400"></i>¥ <%= @room.price %>/泊</span>
  </div>
  <div class="card-body">
    <%= form_for([@room, @room.reservations.new]) do |f| %>
      <div class="row">
        <div class="col-md-6">
          <label>チェックイン</label>
          <%= f.text_field :start_date, readonly: true, placeholder: "日", class: "form-control datepicker" %>
        </div>
        <div class="col-md-6">
          <label>チェックアウト</label>
          <%= f.text_field :end_date, readonly: true, placeholder: "日", class: "form-control datepicker" %>
        </div>
      </div>
     
      <div id="preview" style="display: none;">
        <table class="reservation-table">
          <tbody>
            <tr>
              <td>料金</td>
              <td class="text-right">¥<%= @room.price %></td>
            </tr>
            <tr>
              <td>日数</td>
              <td class="text-right">x<span id="reservation_days"></span></td>
            </tr>
            <tr>
              <td class="total">合計</td>
              <td class="text-right">¥<span id="reservation_total"></span></td>
            </tr>
          </tbody>
        </table>
      </div>
      <br>
      <%= f.submit "予約する", class: "btn btn-normal btn-block" %>
    <% end %>
  </div>
</div>

<script>
  function checkDate(date){
    dmy = date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear();
    return [$.inArray(dmy, unavailableDates) == -1];
  }

  $(function(){

    unavailableDates = [];

    $.ajax({
      url: '<%= preload_room_path(@room) %>',
      dataType: 'json',
      success: function(data){
        $.each(data, function(arrID, arrValue){
          for(var d = new Date(arrValue.start_date); d <= new Date(arrValue.end_date); d.setDate(d.getDate() + 1)){
            unavailableDates.push($.datepicker.formatDate('d-m-yy', d));
          }
        });

        $('#reservation_start_date').datepicker({
          dateFormat: 'dd-mm-yy',
          minDate: 0,
          maxDate: '3m',
          beforeShowDay: checkDate
        });

        $('#reservation_end_date').datepicker({
          dateFormat: 'dd-mm-yy',
          minDate: 0,
          maxDate: '3m',
          beforeShowDay: checkDate
        });
      }
    });
  });

</script>
